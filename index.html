<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBCM Simulator: Tetralogy Edition</title>
    
    <!-- MapLibre & PyScript -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { 
            margin: 0; display: flex; height: 100vh; 
            background: #000; color: #fff; 
            font-family: 'JetBrains Mono', monospace; 
        }
        
        #sidebar {
            width: 420px; padding: 20px; background: rgba(5, 5, 5, 0.95);
            border-right: 1px solid #444; z-index: 2; 
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }
        
        #map { flex-grow: 1; }
        
        h2 { margin: 0; color: #fff; font-size: 1.1rem; border-left: 4px solid #00ffff; padding-left: 10px; }
        .section-label { font-size: 0.7rem; color: #00ffff; margin-top: 15px; border-bottom: 1px solid #333; padding-bottom: 3px;}

        /* INPUTS */
        .input-group { margin-bottom: 5px; }
        .input-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa; margin-bottom: 3px; }
        input[type="number"] {
            background: #222; border: 1px solid #555; color: #fff;
            padding: 5px; width: 95%; font-family: inherit; font-size: 0.9rem;
            border-radius: 3px; text-align: right;
        }
        
        /* SWITCH */
        .switch-box {
            background: #111; border: 1px solid #555; padding: 10px;
            border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
        }
        .switch-label { font-weight: bold; color: #ffd700; }
        
        /* LOGIC DETAILS */
        details { background: #0a0a0a; border: 1px solid #333; padding: 8px; font-size: 0.7rem; color: #888; border-radius: 4px; }
        summary { cursor: pointer; color: #00ff41; font-weight: bold; }
        .math { font-style: italic; color: #ccc; margin: 5px 0; border-left: 2px solid #555; padding-left: 5px; }

        /* MONITOR */
        .monitor-box {
            background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #333;
        }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 2px; }
        .stat-val { font-weight: bold; }
        
        #val-risk { font-size: 2rem; font-weight: bold; display: block; line-height: 1.1; margin-top: 5px; }
        .risk-desc { font-size: 0.7rem; color: #aaa; }

        /* COLORS */
        .safe { color: #00ff41; text-shadow: 0 0 10px rgba(0,255,65,0.3); }
        .gold { color: #ffd700; text-shadow: 0 0 15px rgba(255,215,0,0.5); }
        .warn { color: #ffff00; }
        .danger { color: #ff0055; text-shadow: 0 0 15px rgba(255,0,85,0.5); }

        /* BUTTONS */
        .btn-group { display: flex; gap: 5px; margin-top: auto; }
        button {
            flex: 1; padding: 10px; border: none; border-radius: 3px;
            font-family: inherit; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        #btn-play { background: #00ffff; }
        #btn-pause { background: #444; color: #fff; }
        #btn-reset { background: #333; color: #aaa; }
        button:hover { filter: brightness(1.2); }

    </style>
</head>
<body>

    <div id="sidebar">
        <h2>SBCM SIMULATOR v3.1</h2>
        
        <!-- PART 1: INPUTS -->
        <div class="section-label">>> 1. PARAMETERS (Part 1 & 3)</div>
        
        <div class="input-group">
            <div class="input-label">
                <span>POPULATION ($P$)</span>
                <span>[人]</span>
            </div>
            <input type="number" id="in-pop" value="70000" step="1000" py-change="manual_update">
        </div>
        
        <div class="input-group">
            <div class="input-label">
                <span>TOTAL BUDGET ($I_{budget}$)</span>
                <span>[億円/年]</span>
            </div>
            <input type="number" id="in-cost" value="50" step="1" py-change="manual_update">
        </div>

        <!-- PART 4: G-CART -->
        <div class="section-label">>> 2. FLOW CONTROL (Part 4)</div>
        <div class="switch-box">
            <div>
                <span class="switch-label"><i class="fas fa-network-wired"></i> G-Cart</span><br>
                <span style="font-size:0.7rem; color:#aaa;">Mesh Refinement Protocol</span>
            </div>
            <input type="checkbox" id="g-cart-toggle" py-change="manual_update" style="transform: scale(1.5);">
        </div>

        <!-- LOGIC EXPLANATION -->
        <details style="margin-top:10px;">
            <summary>▼ VIEW LOGIC (The Tetralogy)</summary>
            
            <p><strong>1. Scale Factor ($S$)</strong></p>
            <div class="math">$S = P \div 72,176$ ($B_{std}$)</div>
            
            <p><strong>2. Distortion ($D_{index}$)</strong></p>
            <div class="math">$D_{index} = (I_{budget} \div S) \div 30_{std}$</div>
            <div style="margin-bottom:5px;">*Ref: Standard Maintenance Cost = 30 Oku-yen/Block</div>

            <p><strong>3. Leakage & Retention ($R_{block}$)</strong></p>
            <div class="math">If $I_{budget} > C_{capacity} \to \lambda \approx 1.0$</div>
            <div class="math">$R_{block} = 1.0 - \lambda$</div>
            <div>*G-Cart enables mesh refinement to minimize $\lambda$.</div>
        </details>

        <!-- PART 2: MONITOR -->
        <div class="section-label">>> 3. ANALYSIS (Part 2)</div>
        <div class="monitor-box">
            <div class="stat-row">
                <span>YEAR:</span> <span id="year-disp" style="color:#fff; font-weight:bold;">2025</span>
            </div>
            
            <!-- Scale Factor -->
            <div class="stat-row">
                <span>SCALE ($S$):</span> <span id="val-scale" class="stat-val">--</span>
            </div>

            <!-- Retention -->
            <div class="stat-row">
                <span>RETENTION ($R_{block}$):</span> <span id="val-retention" class="stat-val">--</span>
            </div>
            
            <hr style="border-color:#333; margin:5px 0;">
            
            <!-- Real Value (Part 2) -->
            <span style="font-size:0.7rem;">REAL ECONOMIC VALUE</span>
            <div id="val-value" class="stat-val safe" style="font-size:1.2rem;">--</div>
            <div style="font-size:0.6rem; color:#666;">= Budget × $R_{block}$ × (1 / $D_{index}$)</div>
            
            <hr style="border-color:#333; margin:5px 0;">

            <!-- Risk -->
            <span style="font-size:0.7rem;">DISTORTION INDEX ($D_{index}$)</span>
            <span id="val-risk" class="safe">1.00</span>
            <span id="risk-msg" class="risk-desc">Sustainable</span>
        </div>

        <div class="btn-group">
            <button id="btn-play" py-click="play"><i class="fas fa-play"></i> RUN</button>
            <button id="btn-pause" py-click="pause"><i class="fas fa-pause"></i> STOP</button>
            <button id="btn-reset" py-click="reset">RESET</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- MAP JS -->
    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://tiles.openfreemap.org/styles/dark',
            center: [139.9711, 35.8617],
            zoom: 14.5, pitch: 60, bearing: -20,
            antialias: true
        });

        map.on('load', () => {
            map.addSource('sim-layer', { type: 'geojson', data: {type: 'FeatureCollection', features: []} });
            map.addLayer({
                'id': 'sim-buildings',
                'type': 'fill-extrusion',
                'source': 'sim-layer',
                'paint': {
                    'fill-extrusion-color': ['get', 'color'],
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-opacity': 0.9
                }
            });
        });

        function updateMapData(geoJsonData) {
            const source = map.getSource('sim-layer');
            if(source) source.setData(geoJsonData);
        }
    </script>

    <!-- PYTHON LOGIC (Strict SBCM Implementation) -->
    <script type="py">
        from pyscript import document
        import asyncio
        import json
        import js
        import random

        # CONSTANTS (From Theory)
        B_STD = 72176.0  # Standard Block Population
        C_STD = 30.0     # Standard Maintenance Cost per Block (30億円)
        LOCAL_CAP = 10.0 # Average Local Capacity without G-Cart (10億円)

        state = {
            "running": False,
            "year": 2025,
            "pop": 70000,
            "cost": 50,
            "g_cart": False,
            "s_factor": 1.0,
            "r_block": 0.5,
            "d_index": 1.0,
            "real_val": 0
        }

        # --- CORE LOGIC ---
        def calculate_physics():
            # 1. Scale Factor (Part 1)
            # S = P / 72176
            state["s_factor"] = state["pop"] / B_STD
            if state["s_factor"] < 0.01: state["s_factor"] = 0.01

            # 2. Distortion Index (Part 1)
            # Budget Impact = Cost / S
            # D_index = Impact / Standard_Cost
            budget_impact = state["cost"] / state["s_factor"]
            state["d_index"] = budget_impact / C_STD

            # 3. Leakage & Retention (Part 4)
            is_gcart = document.getElementById("g-cart-toggle").checked
            state["g_cart"] = is_gcart

            if is_gcart:
                # G-Cart ON: Mesh Refinement -> Max Retention
                state["r_block"] = 0.95
            else:
                # G-Cart OFF: Vector Overflow -> Leakage
                # Region Capacity scales with size (S)
                current_capacity = LOCAL_CAP * state["s_factor"]
                
                # Ratio of Budget to Capacity
                overflow_ratio = state["cost"] / current_capacity
                
                if overflow_ratio <= 1.0:
                    state["r_block"] = 0.9 # Within capacity
                else:
                    # Leakage increases as overflow increases
                    # Simple saturation curve
                    state["r_block"] = max(0.05, 1.0 / overflow_ratio)

            # 4. Real Economic Value (Part 2)
            # Value = Cost * R_block * (Efficiency Factor)
            # High distortion reduces efficiency (Waste)
            efficiency = 1.0 / max(1.0, state["d_index"] / 2.0) # D_index 2.0 is tolerance
            state["real_val"] = state["cost"] * state["r_block"] * efficiency

        # --- UI UPDATE ---
        def update_ui():
            document.getElementById("year-disp").innerText = str(state["year"])
            
            # S Factor
            document.getElementById("val-scale").innerText = f"{state['s_factor']:.2f}"

            # Retention
            r_pct = int(state["r_block"] * 100)
            el_ret = document.getElementById("val-retention")
            el_ret.innerText = f"{r_pct}%"
            el_ret.style.color = "#00ff41" if r_pct > 80 else "#ff0055"

            # Real Value
            el_val = document.getElementById("val-value")
            el_val.innerText = f"{state['real_val']:.1f} 億円"
            
            # Color Logic for Value
            if state["g_cart"] and state["d_index"] < 5.0: el_val.className = "stat-val gold"
            elif state["real_val"] < (state["cost"] * 0.2): el_val.className = "stat-val danger"
            else: el_val.className = "stat-val safe"

            # Distortion (Risk)
            d_val = state["d_index"]
            el_risk = document.getElementById("val-risk")
            el_msg = document.getElementById("risk-msg")
            
            el_risk.innerText = f"{d_val:.2f}"
            
            if d_val < 2.0:
                el_risk.className = "safe"
                el_msg.innerText = "Healthy (健全)"
            elif d_val < 10.0:
                el_risk.className = "warn"
                el_msg.innerText = "Distorted (歪みあり)"
            else:
                el_risk.className = "danger"
                el_msg.innerText = "CRITICAL (破綻水準)"

        # --- MAP RENDER ---
        def render_map():
            features = []
            grid = 5
            center = 2.5
            
            d_val = state["d_index"]
            r_val = state["r_block"]
            
            # 崩壊ロジック: Distortionが高く、Retentionが低いと崩れる
            # Stability = R_block / D_index
            stability = (r_val * 10) / d_val
            
            decay = 1.0
            if stability < 0.5: # Unstable
                decay = max(0.1, stability)
            
            # 成長ロジック: G-Cart ONなら育つ
            growth = 1.0
            if state["g_cart"]:
                growth = 1.0 + (state["year"] - 2025) * 0.03

            for x in range(grid):
                for y in range(grid):
                    dist = ((x - center)**2 + (y - center)**2)**0.5
                    base_h = max(5, 50 - (dist * 10))
                    
                    final_h = base_h * decay * growth
                    
                    # COLOR
                    if d_val > 10.0: color = "#ff0055" # Critical
                    elif state["g_cart"]: color = "#ffd700" # Gold
                    elif d_val > 2.0: color = "#ffff00" # Warn
                    else: color = "#00ff41" # Safe
                    
                    if final_h < 5: color = "#333" # Ruin

                    features.append({
                        "type": "Feature",
                        "properties": {"color": color, "height": final_h},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[
                                [139.970 + (x*0.001), 35.861 + (y*0.001)],
                                [139.971 + (x*0.001), 35.861 + (y*0.001)],
                                [139.971 + (x*0.001), 35.862 + (y*0.001)],
                                [139.970 + (x*0.001), 35.862 + (y*0.001)],
                                [139.970 + (x*0.001), 35.861 + (y*0.001)]
                            ]]
                        }
                    })
            
            geo = {"type": "FeatureCollection", "features": features}
            js.updateMapData(js.JSON.parse(json.dumps(geo)))

        # --- EVENTS ---
        def manual_update(e=None):
            if state["running"]: return
            state["pop"] = int(document.getElementById("in-pop").value)
            state["cost"] = int(document.getElementById("in-cost").value)
            calculate_physics()
            update_ui()
            render_map()

        async def run_loop():
            while state["running"]:
                state["year"] += 1
                
                # Part 3: Dynamics (Depopulation & Inflation)
                state["pop"] = int(state["pop"] * 0.985) # -1.5%
                state["cost"] = int(state["cost"] * 1.03) # +3.0% (Aging)
                
                if state["g_cart"]:
                    state["cost"] = int(state["cost"] * 0.98) # Optimization

                document.getElementById("in-pop").value = state["pop"]
                document.getElementById("in-cost").value = state["cost"]
                
                calculate_physics()
                update_ui()
                render_map()
                
                if state["year"] > 2075: state["running"] = False
                await asyncio.sleep(0.2)

        def play(e):
            if not state["running"]:
                state["running"] = True
                asyncio.create_task(run_loop())
        
        def pause(e): state["running"] = False
        def reset(e):
            state["running"] = False
            state["year"] = 2025
            document.getElementById("in-pop").value = 70000
            document.getElementById("in-cost").value = 50
            document.getElementById("g-cart-toggle").checked = False
            manual_update()

        manual_update()
    </script>
</body>
</html>
